workdir = "deployment_artifacts"
project_home = "https://github.com/data-capsule/psl-cvm"

[deployment_config]
provider = "aws"
mode = "modest"
ssh_key = "cluster_key.pem"
ssh_user = "psladmin"
node_port_base = 3000

[node_config]

[node_config.net_config]
client_max_retry = 10

[node_config.rpc_config]
recv_buffer_size = 32768
channel_depth = 1000

[node_config.consensus_config]
commit_index_gap_soft = 250
commit_index_gap_hard = 5000
liveness_u = 0
max_backlog_batch_size = 1000
signature_max_delay_blocks = 10
signature_max_delay_ms = 10000
num_crypto_workers = 16
view_timeout_ms = 4000
batch_max_delay_ms = 50
max_audit_snapshots = 100_000 # Essentially disable audit blocking.
max_audit_buffer_size = 1000
max_audit_delay_ms = 1000

[node_config.consensus_config.log_storage_config.RocksDB]
write_buffer_size = 67_108_864 # 64MB
max_write_buffer_number = 20
max_write_buffers_to_merge = 1

[node_config.worker_config.state_storage_config.RocksDB]
write_buffer_size = 67_108_864 # 64MB
max_write_buffer_number = 20
max_write_buffers_to_merge = 10

[node_config.worker_config]
all_writes_max_batch_size = 1000
self_writes_max_batch_size = 16
self_reads_max_batch_size = 16
batch_max_delay_ms = 50
heartbeat_max_delay_ms = 60_000 # Essentially disable heartbest. This causes throughput issues.
signature_max_delay_ms = 20000
signature_max_delay_blocks = 50
num_crypto_workers = 5
num_worker_threads_per_worker = 4
num_replier_threads_per_worker = 4
read_cache_size = 100_000


[node_config.app_config]
logger_stats_report_ms = 1000
checkpoint_interval_ms = 1000

[node_config.evil_config]
simulate_byzantine_behavior = false
byzantine_start_block = 0


[client_config]
full_duplex = true
client_sub_id = 0       # This is filled up later by the caller code.


[client_config.net_config]
client_max_retry = 10

[client_config.workload_config]
max_concurrent_requests = 16
ramp_up_ms = 10_000
ramp_down_ms = 10_000

# Key transparency shares the same workload characteristics as YCSB.
# Just the app does something different.
[client_config.workload_config.request_config.KVReadWriteYCSB]
num_keys = 300_000
num_fields = 1
val_size = 100
linearizable_reads = false
byz_commit_ratio = 0.0
load_phase = false
zipf_exponent = 0.99
read_ratio = 0.5

[[experiments]]
name = "kt_psl"
type = "psl_storage"
# git_hash = "209b1804ff2c2259aced1f0960f48167b1966b94"
repeats = 1
num_clients = 16
num_nodes = 16
num_storage_nodes = 3
num_sequencer_nodes = 1
node_distribution = "tag:worker"
storage_distribution = "uniform"
sequencer_distribution = "tag:sequencer"
build_command = "make"
duration = 30
data_dir = "/data/"

[experiments.sweeping_parameters]
# num_nodes = [1, 2, 4, 8, 16]
num_nodes = [16]
# num_clients = [16, 32, 48]


# [[experiments]]
# name = "smallbank_nimble"
# type = "nimble"
# # git_hash = "209b1804ff2c2259aced1f0960f48167b1966b94"
# repeats = 1
# num_clients = 256
# # num_nodes = 15
# num_storage_nodes = 0
# num_sequencer_nodes = 4 # 1 coordinator + 3 endorsers
# node_distribution = "tag:worker"
# storage_distribution = "uniform"
# sequencer_distribution = "uniform"
# build_command = "make nimble"
# duration = 90
# data_dir = "/data/"

# [experiments.sweeping_parameters]
# # num_nodes = [1, 15, 31, 63]
# num_nodes = [1, 2, 4, 8, 16]



# [[experiments]]
# name = "smallbank_unprotected"
# type = "psl_storage"
# # git_hash = "209b1804ff2c2259aced1f0960f48167b1966b94"
# repeats = 1
# num_clients = 256
# # num_nodes = 15
# num_storage_nodes = 0
# num_sequencer_nodes = 1
# node_distribution = "tag:worker"
# storage_distribution = "uniform"
# sequencer_distribution = "uniform"
# build_command = "make"
# duration = 90
# data_dir = "/data/"

# [experiments.sweeping_parameters]
# num_nodes = [1, 2, 4, 8, 16]
# # num_nodes = [30, 40, 50, 60]



[[results]]
name = "stacked_bar_graph"
plotter = "stacked_bar_graph_psl"
ramp_up = 10
ramp_down = 10
output = "kt_worker_scale.pdf"
force_parse = true
# xlabels = ["1", "15", "31", "63"]
# xlabels = ["1", "2", "4", "8", "16"]
xlabels = ["16"]
xtitle = "Number of Nodes"
# legend_order = ["Nimble", "HarborMaster", "Unprotected"]
legend_order = ["HarborMaster"]


[results.legends]
kt_psl = "HarborMaster"
kt_nimble = "Nimble"
kt_unprotected = "Unprotected"

# [[results]]
# name = "throughput_latency_client_sweep"
# plotter = "tput_latency_sweep_psl"
# ramp_up = 10
# ramp_down = 10
# output = "tput_latency_sweep.pdf"
# force_parse = true

# [results.legends]
# kt_psl = "HarborMaster"
# ycsb_r50_w16_nimble = "nimble"
# ycsb_r50_w16_unprotected = "unprotected"
